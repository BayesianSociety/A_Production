<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cube Collector — React Three Fiber (no JSX)</title>
<style>
  html, body, #root { margin: 0; height: 100%; }
  #ui { position: fixed; top: 12px; left: 12px; background: rgba(0,0,0,.55); color: #fff; padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.3; z-index: 10; }
  canvas { display: block; }
</style>
</head>
<body>
  <div id="ui">
    <div><b>Cube Collector</b> · React Three Fiber</div>
    <div>Score: <span id="score">0</span></div>
    <div>Move: WASD / Arrow Keys</div>
  </div>
  <div id="root"></div>

  <script type="module">
    import React, { useEffect, useRef, useState } from 'https://esm.sh/react@18.3.1';
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import * as THREE from 'https://esm.sh/three@0.160.0';
    // Make Fiber reuse the same React/ReactDOM/THREE singletons:
    import { Canvas, useFrame, useThree } from 'https://esm.sh/@react-three/fiber@8.15.15?external=react,react-dom,three';

    const e = React.createElement;

    function useKeys() {
      const keys = useRef({});
      useEffect(() => {
        const down = (evt) => (keys.current[evt.key.toLowerCase()] = true);
        const up   = (evt) => (keys.current[evt.key.toLowerCase()] = false);
        addEventListener('keydown', down);
        addEventListener('keyup', up);
        return () => { removeEventListener('keydown', down); removeEventListener('keyup', up); };
      }, []);
      return keys;
    }

    function Game() {
      const { camera } = useThree();
      const player = useRef();
      const coin = useRef();
      const vel = useRef(new THREE.Vector3());
      const keys = useKeys();
      const [score, setScore] = useState(0);

      useEffect(() => {
        const el = document.getElementById('score');
        if (el) el.textContent = String(score);
      }, [score]);

      const bounds = 9, PLAYER_SIZE = 1, COIN_R = 0.35;
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const respawnCoin = () => {
        if (!coin.current) return;
        coin.current.position.set((Math.random()*2-1)*bounds*0.9, 0.35, (Math.random()*2-1)*bounds*0.9);
      };
      useEffect(respawnCoin, []);

      useFrame((_, _dt) => {
        const dt = Math.min(0.05, _dt);
        const k = keys.current;
        let ax = 0, az = 0;
        if (k['w'] || k['arrowup'])    az -= 1;
        if (k['s'] || k['arrowdown'])  az += 1;
        if (k['a'] || k['arrowleft'])  ax -= 1;
        if (k['d'] || k['arrowright']) ax += 1;

        const v = vel.current; const speed = 6, friction = 6;
        if (ax || az) {
          const len = Math.hypot(ax, az) || 1;
          v.x += (ax/len) * speed * dt;
          v.z += (az/len) * speed * dt;
        }
        v.x -= v.x * Math.min(1, friction * dt);
        v.z -= v.z * Math.min(1, friction * dt);

        const p = player.current.position;
        p.x = clamp(p.x + v.x * dt, -bounds, bounds);
        p.z = clamp(p.z + v.z * dt, -bounds, bounds);

        coin.current.rotation.z += 2 * dt;
        if (p.distanceTo(coin.current.position) < PLAYER_SIZE * 0.6 + COIN_R) {
          setScore(s => s + 1);
          respawnCoin();
        }

        const target = new THREE.Vector3().copy(player.current.position).add(new THREE.Vector3(0,2,5));
        camera.position.lerp(target, 1 - Math.pow(0.001, dt));
        camera.lookAt(player.current.position);
      });

      return e(React.Fragment, null,
        // Lights
        e('ambientLight', { intensity: 0.6 }),
        e('directionalLight', { position: [5,10,2], intensity: 0.8 }),

        // Ground
        e('mesh', { rotation: [-Math.PI/2, 0, 0] },
          e('planeGeometry', { args: [20, 20] }),
          e('meshPhongMaterial', { color: 0x2a9d8f })
        ),

        // Player
        e('mesh', { ref: player, position: [0, 0.5, 0] },
          e('boxGeometry', { args: [1, 1, 1] }),
          e('meshStandardMaterial', { color: 0xffc300, metalness: 0.2, roughness: 0.6 })
        ),

        // Coin
        e('mesh', { ref: coin, rotation: [Math.PI/2, 0, 0] },
          e('torusGeometry', { args: [0.35, 0.15, 12, 24] }),
          e('meshStandardMaterial', { color: 0xf72585, emissive: 0x220011 })
        )
      );
    }

    function App() {
      return e(Canvas, { camera: { fov: 60, position: [0, 6, 10] } }, e(Game));
    }

    createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
